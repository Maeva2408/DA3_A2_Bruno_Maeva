---
title: 'Finding fast growing firms'
author: "Maeva Braeckevelt and Brúnó Helmeczy"
output:
  html_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Executive Summary
This analysis aimed at predicting the fast growing of a firm.


```{r, include=F, message=FALSE, echo=FALSE, eval=TRUE}
setwd("C:/Users/mbrae/OneDrive/Bureau/CEU/DA3/A1/")
#### SET UP

# CLEAR MEMORY
rm(list=ls())


# Import libraries
library(haven)
library(glmnet)
library(purrr)
library(margins)
library(skimr)
library(kableExtra)
library(Hmisc)
library(cowplot)
library(gmodels) 
library(lspline)
library(sandwich)
library(modelsummary)

library(rattle)
library(caret)
library(pROC)
library(ranger)
library(rpart)
library(partykit)
library(rpart.plot)


# set working directory
data_dir <- paste0(getwd(),"/DA3_A2_Bruno_Maeva/")
SourceFunctions <- paste0("https://raw.githubusercontent.com/Maeva2408/DA3_A2_Bruno_Maeva/main/code/functions/")

# load theme and functions
source(paste0(SourceFunctions,"theme_bg.R"))
source(paste0(SourceFunctions,"da_helper_functions.R"))

data_in <- paste(data_dir,"data/clean/", sep = "/")
output <- paste0(data_dir,"output/")
create_output_if_doesnt_exist(output)
data_out <- paste(data_dir,"data/clean/", sep = "/")



###########################################################
# Import data
###########################################################

dataraw <- read_csv("https://raw.githubusercontent.com/Maeva2408/DA3_A2_Bruno_Maeva/main/data/clean/cs_bisnode_panel.csv")

data <- dataraw


# drop variables with many NAs
data <- data %>%
  select(-c(COGS, finished_prod, net_dom_sales, net_exp_sales, wages)) %>%
  filter(year !=2016)

###########################################################
# label engineering
###########################################################

# add all missing year and comp_id combinations -
# originally missing combinations will have NAs in all other columns
data <- data %>%
  complete(year, comp_id)

# generate status_alive; if sales larger than zero and not-NA, then firm is alive
data  <- data %>%
  mutate(status_alive = sales > 0 & !is.na(sales) %>%
           as.numeric(.))

# defaults in two years if there are sales in this year but no sales two years later
data <- data %>%
  group_by(comp_id) %>%
  mutate(default = ((status_alive == 1) & (lead(status_alive, 2) == 0)) %>%
           as.numeric(.),
         CAGR = ifelse( ( (is.na(lead(sales, 2))) & (status_alive == 1) ),
                             0,((lead(sales, 2) / sales )^(1/2) - 1)*100) ) %>%
  ungroup()

data <- data %>% mutate(
  HyperGrowth = CAGR >= 30) %>% 
  filter(year <=2013)



```

# Introduction

This analysis aimed at predicting the fast growth of firms between 2012 and 2014. This analysis could help an investor to decide to invest in a certain company or not.
The data we used was created by Bisnode, a major European business information company. The original dataset, bisnode-firms, contains the entire population of companies between 2005 and 2016 in Manufacturing (Electrical equiment, Motor vehicles, etc) and services (Accommodation and food and beverage services activities).

# Data

## Label engineering

The first step of this analysis was to define fast growth. To do so, we used the compound annual growth rate formula. 

CAGR = (Vfinal/Vbegin)^1/t - 1 


t being the time in years, we defined it as 2. 
It seems logic for us that if an investor took interest in a firm, he will be able only to invest the year later.
Vbegin is the Sales (€) in the year ongoing
Vfinal is the Sales (€) in the year +2

we converted in percentage.
we defined any firm that have a % CAGR of bigger or equal at 30% in two years as a fast growing firm, it means that they growth for 70% in two years.

## Sample design

Our sample is defined as 
- Firms still in business in 2012
- Firms that have sales between 10 000€ and 10 millions €

Our fast growing firms are compound annual growth percentage bigger or equal at 30% in two year

After having design our sample, we end up with 15692 companies and 2220 of them (14%) are fast growing.

```{r, eval=TRUE, echo=FALSE, results='asis'}


```
## Feature engineering
#MAEVa
Now, We need to select our x variables and maybe transform them but before we need to clean them.
- Some of the variable are financial accounts (like inventories, current liabilities, etc), so they can't be negative, thus we decided to replace the negative value to 0.
- We created ratios , easier for interpretation and spotting extreme values
- we used the a method called winsorization 
- We elevated some variable to a quadratic function
- We took the log of sales.

We decided to classify the variable 

* **Firm**, _5 variables_ : Age of firm, squared age, a dummy if newly established, industry categories, location regions for its headquarters, and dummy if located in a big city

* **Financial 1**,  _16 variables_ : Winsorized financial variables : sales, fixed, liquid, current, intangible assets, curret liabilities, inventories, equity shares, subscribed capital, sales revenues, income before tax, extra income, material, personal and extra expenditure, extra profit.

* **Financial 2** : Flags (extrem, low, high, zero - when applicable) and polynomials : quadratic term are created for profit and loss, extra profit and loss, income before tax, and share equity.

* **Financial 3** : % blance sheet, % profite and loss

* **Growth**, _X variable_ : Sales growth is captured by a winsorized growth variable, its quadratic term and flags for extreme low and high values.

* **HR**, _5 variable_ : 5 variables :  For the CEO: Female dummy, winsorized age and flags, flags for missing information; foreign management dummy; labor cost, and flag for missing labor cost information.

* **Data quality**, _3 variables_: Variables related to the data quality of the financial information, flag for a problem, and the length of the year that the balance sheet covers.

We chose to include some interactions as well, that we defined by common knwoledge.

* **Interaction** : Interactions with the sales growth, firm size, and industry

```{r, eval=TRUE, echo=FALSE, results='asis'}

```

# Probability prediction and model selection

We decided to use three different models for the prediction of fast growing firm : Logit, Lasso and random forest.

## Logit
```{r, include=F, message=FALSE, echo=FALSE, eval=TRUE}

```
We started by carrying out a probability prediction by logit. Used cross-validation to select the best model and used the holdout to determine the prediction form that model. 

We created five different models. The predictors of the two first models were handpicked and then we gradually add more categories at each models.

* **X1** : Log of sales in Millions, the square of the Log of sales in Millions , Winsorized value of the change of the log of Sales versus last year, profit and loss by total sales, Industries categories

* **X2** : X1, fixed assets divided by total assets, share equity divided by total assets,current liability divided by total assets, hight flags for current liability divided by total assets, flag error for current liability divided by total assets,age, foreign_management

* **X3** : Log of sales in Millions, the square of the Log of sales in Millions, Firm, Financial 1, Growth

* **X4** : Log of sales in Millions, the square of the Log of sales in Millions, Firm, Financial 1, Growth, _Financial 2_, _HR_, _Data quality_

* **X5** : Log of sales in Millions, the square of the Log of sales in Millions, Firm, Financial 1, Growth , Financial 2, HR, Data quality, _Intercactions_

# variables - tables
# Ratio EBITDA
# Show RMSE
# Choose the model




```{r, eval=TRUE, echo=FALSE, results='asis', warning= FALSE}

```

## Lasso

```{r, include=F, message=FALSE, echo=FALSE, eval=TRUE}


```
# all variables
# comparing lasso to the best logit


## Random forest
```{r, include=F, message=FALSE, echo=FALSE, eval=TRUE}

```
# variable from our best logit model (take off the interaction)
# models

```{r, include=F, message=FALSE, echo=FALSE, eval=TRUE}

```

# Classification

```{r, include=F, message=FALSE, echo=FALSE, eval=TRUE}


```


```{r, eval=TRUE, echo=FALSE, results='asis'}

```



```{r, eval=TRUE, echo=FALSE, results='asis'}

```


# Conclusion / Summary

